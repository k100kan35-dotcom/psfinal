#!/usr/bin/env python3
"""Verify that average_fg_curves with strain_split=DEFAULT_STRAIN_SPLIT works correctly."""
import sys
import numpy as np

sys.path.insert(0, '/home/user/psfinal')
from persson_model.utils.data_loader import (
    compute_fg_from_strain_sweep, average_fg_curves, DEFAULT_STRAIN_SPLIT
)

# ── Raw data ────────────────────────────────────
raw_data = {
    0.02: [
        (1,0.00998199,12.3965,1.76989),(1,0.0133129,12.3579,1.77681),(1,0.0177461,12.3418,1.78331),
        (1,0.0236596,12.3492,1.80447),(1,0.031558,12.2931,1.8164),(1,0.0420875,12.2247,1.83397),
        (1,0.0561241,12.1139,1.85492),(1,0.0748532,11.96,1.88646),(1,0.099816,11.7526,1.92113),
        (1,0.133117,11.4914,1.95493),(1,0.177512,11.1729,1.98251),(1,0.236721,10.8024,2.00125),
        (1,0.315669,10.3899,2.00493),(1,0.42097,9.94642,1.99124),(1,0.561402,9.47247,1.95595),
        (1,0.748652,8.97981,1.90113),(1,0.998458,8.46497,1.82624),(1,1.33148,7.93229,1.73507),
        (1,1.77568,7.38546,1.63276),(1,2.36817,6.81151,1.52133),(1,3.15846,6.20654,1.40454),
        (1,4.21252,5.57118,1.28468),(1,5.6189,4.91792,1.16317),(1,7.49479,4.27492,1.04087),
        (1,9.99712,3.67123,0.915441),(1,13.3315,3.12654,0.783644),(1,17.7678,2.65958,0.647271),
        (1,24.0898,2.39459,0.510474),(1,25.1467,2.34769,0.47739),
    ],
    9.94: [
        (1,0.0099875,10.9768,1.35416),(1,0.0133212,10.9577,1.34117),(1,0.017767,10.943,1.34462),
        (1,0.0236861,10.9141,1.35255),(1,0.0315812,10.8752,1.3618),(1,0.042114,10.7959,1.37742),
        (1,0.0561403,10.6951,1.39078),(1,0.0748584,10.5596,1.41098),(1,0.0998339,10.3817,1.43529),
        (1,0.133138,10.1641,1.46189),(1,0.177559,9.89803,1.48585),(1,0.236777,9.5962,1.50286),
        (1,0.315749,9.26689,1.50928),(1,0.421055,8.9119,1.50267),(1,0.561495,8.53631,1.48018),
        (1,0.748819,8.13766,1.44313),(1,0.998588,7.72817,1.3897),(1,1.33171,7.29787,1.3244),
        (1,1.77597,6.84293,1.24907),(1,2.3686,6.35803,1.16787),(1,3.15909,5.83214,1.08212),
        (1,4.21328,5.2652,0.993642),(1,5.61951,4.66899,0.9036),(1,7.49538,4.07185,0.812517),
        (1,9.9975,3.50604,0.719437),(1,13.3325,3.00446,0.623393),(1,17.7732,2.56688,0.523096),
        (1,23.7157,2.29471,0.420665),(1,26.3193,2.23593,0.381457),
    ],
    29.9: [
        (1,0.00993227,7.92113,0.812626),(1,0.0133018,7.85741,0.793673),(1,0.0177287,7.82279,0.797681),
        (1,0.0236355,7.81039,0.8005),(1,0.0315658,7.75717,0.806546),(1,0.0420936,7.71052,0.81615),
        (1,0.0560989,7.64443,0.823229),(1,0.0748367,7.56082,0.823972),(1,0.0997999,7.4614,0.825199),
        (1,0.133073,7.33974,0.82181),(1,0.177427,7.20522,0.824052),(1,0.236635,7.05659,0.828837),
        (1,0.315539,6.89171,0.832713),(1,0.420773,6.71473,0.834018),(1,0.561073,6.52162,0.829128),
        (1,0.748208,6.31242,0.817982),(1,0.99778,6.08633,0.799891),(1,1.33063,5.83939,0.775213),
        (1,1.77458,5.56679,0.744597),(1,2.3666,5.2637,0.709913),(1,3.1564,4.92131,0.672274),
        (1,4.20982,4.52905,0.631911),(1,5.61481,4.08678,0.588998),(1,7.4889,3.61581,0.543269),
        (1,9.98856,3.15133,0.494747),(1,13.3223,2.72296,0.441901),(1,17.7651,2.35499,0.383864),
        (1,23.6793,2.05225,0.322323),(1,31.7316,1.90996,0.263056),
    ],
    49.99: [
        (1,0.00991974,6.36074,0.564004),(1,0.0133148,6.32266,0.531796),(1,0.0176711,6.33331,0.545917),
        (1,0.0236869,6.29266,0.530814),(1,0.0315095,6.29257,0.542256),(1,0.0420438,6.25757,0.544083),
        (1,0.0560571,6.232,0.543356),(1,0.0747942,6.19966,0.550299),(1,0.0997915,6.15963,0.553352),
        (1,0.133103,6.10052,0.559198),(1,0.177507,6.03305,0.56475),(1,0.236681,5.95228,0.570907),
        (1,0.315597,5.85864,0.57597),(1,0.420808,5.75195,0.578493),(1,0.561103,5.63059,0.577807),
        (1,0.748215,5.49496,0.573712),(1,0.997827,5.34245,0.565579),(1,1.33076,5.16955,0.553316),
        (1,1.77476,4.97189,0.537297),(1,2.36687,4.74285,0.517747),(1,3.15656,4.47503,0.495432),
        (1,4.2097,4.16225,0.470468),(1,5.61436,3.8047,0.443194),(1,7.48803,3.4133,0.413561),
        (1,9.98679,3.01052,0.381353),(1,13.3194,2.62562,0.345818),(1,17.761,2.27965,0.305989),
        (1,23.6769,1.99052,0.26321),
    ],
}

data_by_T = {}
for T, rows in raw_data.items():
    data_by_T[T] = [(freq, strain, ReE, ImE) for (freq, strain, ReE, ImE) in rows]

exp_strain = np.array([
    1.49E-04, 2.22E-04, 3.33E-04, 4.98E-04, 7.46E-04,
    1.12E-03, 1.67E-03, 2.50E-03, 3.75E-03, 5.61E-03,
    8.40E-03, 1.26E-02, 1.88E-02, 2.82E-02, 4.22E-02,
    6.32E-02, 9.46E-02, 1.42E-01, 2.12E-01, 3.17E-01,
])
exp_f = np.array([
    0.995, 0.992, 0.988, 0.978, 0.965,
    0.944, 0.917, 0.896, 0.859, 0.818,
    0.773, 0.725, 0.691, 0.633, 0.567,
    0.493, 0.418, 0.374, 0.318, 0.304,
])
exp_g = np.array([
    0.983, 0.986, 0.997, 1.010, 1.025,
    1.042, 1.060, 1.071, 1.077, 1.068,
    1.037, 0.989, 0.949, 0.881, 0.808,
    0.733, 0.656, 0.601, 0.490, 0.413,
])

fg_by_T = compute_fg_from_strain_sweep(
    data_by_T, target_freq=1.0, freq_mode='nearest',
    strain_is_percent=True, e0_n_points=5, clip_leq_1=False
)

all_temps = sorted(fg_by_T.keys())

# ── 1) Legacy (strain_split=None) ───────────────
res_legacy = average_fg_curves(
    fg_by_T, all_temps, exp_strain,
    interp_kind='loglog_linear', avg_mode='mean', clip_leq_1=False,
    strain_split=None
)

# ── 2) NEW: strain_split=DEFAULT_STRAIN_SPLIT ───
res_split = average_fg_curves(
    fg_by_T, all_temps, exp_strain,
    interp_kind='loglog_linear', avg_mode='mean', clip_leq_1=False,
    strain_split=DEFAULT_STRAIN_SPLIT
)

# ── 비교 출력 ───────────────────────────────────
print("=" * 130)
print(f"DEFAULT_STRAIN_SPLIT = {DEFAULT_STRAIN_SPLIT}")
print("=" * 130)

print(f"\n{'Strain':>12s}  │ {'f_legacy':>8s}  {'f_split':>8s}  {'f_exp':>8s}  {'Δlegacy%':>9s}  {'Δsplit%':>9s}  │ "
      f"{'g_legacy':>8s}  {'g_split':>8s}  {'g_exp':>8s}  {'Δlegacy%':>9s}  {'Δsplit%':>9s}")
print("─" * 130)

threshold = DEFAULT_STRAIN_SPLIT['threshold']
for j in range(len(exp_strain)):
    fl = res_legacy['f_avg'][j]
    fs = res_split['f_avg'][j]
    gl = res_legacy['g_avg'][j]
    gs = res_split['g_avg'][j]
    fe = exp_f[j]
    ge = exp_g[j]

    f_err_l = (fl - fe) / fe * 100
    f_err_s = (fs - fe) / fe * 100
    g_err_l = (gl - ge) / ge * 100
    g_err_s = (gs - ge) / ge * 100

    zone = "HIGH" if exp_strain[j] >= threshold else "    "
    print(f"{exp_strain[j]:12.4e}  │ {fl:8.4f}  {fs:8.4f}  {fe:8.3f}  {f_err_l:+9.2f}  {f_err_s:+9.2f}  │ "
          f"{gl:8.4f}  {gs:8.4f}  {ge:8.3f}  {g_err_l:+9.2f}  {g_err_s:+9.2f}  {zone}")

# ── MAE 요약 ────────────────────────────────────
f_mae_l = np.nanmean(np.abs(res_legacy['f_avg'] - exp_f) / exp_f * 100)
f_mae_s = np.nanmean(np.abs(res_split['f_avg'] - exp_f) / exp_f * 100)
g_mae_l = np.nanmean(np.abs(res_legacy['g_avg'] - exp_g) / exp_g * 100)
g_mae_s = np.nanmean(np.abs(res_split['g_avg'] - exp_g) / exp_g * 100)

print(f"\n{'=' * 130}")
print(f"  Legacy  (strain_split=None):             f MAE={f_mae_l:.2f}%,  g MAE={g_mae_l:.2f}%,  합산={(f_mae_l+g_mae_l)/2:.2f}%")
print(f"  NEW     (strain_split=DEFAULT):          f MAE={f_mae_s:.2f}%,  g MAE={g_mae_s:.2f}%,  합산={(f_mae_s+g_mae_s)/2:.2f}%")
print(f"  개선율: {((f_mae_l+g_mae_l)/2 - (f_mae_s+g_mae_s)/2) / ((f_mae_l+g_mae_l)/2) * 100:.1f}%")
